# API è®¤è¯ç³»ç»Ÿå®ç°æ€»ç»“

## å®ç°æ¦‚è¿°

**å®ç°æ—¶é—´**: 2026-02-21  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ç›®æ ‡**: ä¸ºè´¦å·ç®¡ç†ç³»ç»Ÿæ·»åŠ å®Œæ•´çš„è®¤è¯å’ŒæˆæƒåŠŸèƒ½

---

## å®ç°çš„åŠŸèƒ½

### 1. åŒé‡è®¤è¯æœºåˆ¶

#### âœ… JWT è®¤è¯

- **ç”¨é€”**: ç”¨æˆ·ç™»å½•åœºæ™¯
- **ç®—æ³•**: HS256
- **æœ‰æ•ˆæœŸ**: 24 å°æ—¶ï¼ˆå¯é…ç½®ï¼‰
- **åŒ…å«ä¿¡æ¯**: ç”¨æˆ· IDã€ç”¨æˆ·åã€è§’è‰²

**å®ç°æ–‡ä»¶**:
- `publisher-core/auth/middleware.go` - JWT ç”Ÿæˆå’ŒéªŒè¯
- `publisher-core/auth/user_service.go` - ç™»å½•é€»è¾‘

#### âœ… API Key è®¤è¯

- **ç”¨é€”**: æœåŠ¡é—´è°ƒç”¨ã€è‡ªåŠ¨åŒ–è„šæœ¬
- **æ ¼å¼**: `pk_` + 64 ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²
- **ç‰¹ç‚¹**: æ°¸ä¹…æœ‰æ•ˆï¼Œå¯é‡æ–°ç”Ÿæˆ

**å®ç°æ–‡ä»¶**:
- `publisher-core/auth/middleware.go` - API Key éªŒè¯
- `publisher-core/auth/user_service.go` - API Key ç”Ÿæˆ

---

### 2. ç”¨æˆ·ç®¡ç†åŠŸèƒ½

#### âœ… ç”¨æˆ·æ³¨å†Œ

- ç”¨æˆ·åã€é‚®ç®±å”¯ä¸€æ€§æ£€æŸ¥
- å¯†ç å¼ºåº¦éªŒè¯ï¼ˆè‡³å°‘ 8 ä¸ªå­—ç¬¦ï¼‰
- è‡ªåŠ¨ç”Ÿæˆ API Key
- å¯†ç  bcrypt å“ˆå¸Œå­˜å‚¨

#### âœ… ç”¨æˆ·ç™»å½•

- æ”¯æŒç”¨æˆ·åæˆ–é‚®ç®±ç™»å½•
- å¯†ç éªŒè¯
- ç”Ÿæˆ JWT Token
- æ›´æ–°æœ€åç™»å½•æ—¶é—´

#### âœ… ç”¨æˆ·ä¿¡æ¯ç®¡ç†

- æŸ¥çœ‹å½“å‰ç”¨æˆ·ä¿¡æ¯
- æ›´æ–°é‚®ç®±å’Œå¯†ç 
- é‡æ–°ç”Ÿæˆ API Key
- ä¿®æ”¹å¯†ç ï¼ˆéœ€éªŒè¯æ—§å¯†ç ï¼‰

#### âœ… ç®¡ç†å‘˜åŠŸèƒ½

- åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·
- æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
- ä¿®æ”¹ç”¨æˆ·è§’è‰²
- ç¦ç”¨/å¯ç”¨ç”¨æˆ·

---

### 3. æƒé™æ§åˆ¶

#### âœ… åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰

**è§’è‰²å®šä¹‰**:
- `user`: æ™®é€šç”¨æˆ·ï¼Œåªèƒ½è®¿é—®è‡ªå·±çš„èµ„æº
- `admin`: ç®¡ç†å‘˜ï¼Œå¯ä»¥è®¿é—®æ‰€æœ‰èµ„æº

**æƒé™æ£€æŸ¥**:
- `RequireRole()`: è¦æ±‚ç‰¹å®šè§’è‰²
- `RequireOwner()`: è¦æ±‚èµ„æºæ‰€æœ‰è€…æˆ–ç®¡ç†å‘˜

#### âœ… èµ„æºè®¿é—®æ§åˆ¶

- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±åˆ›å»ºçš„è´¦å·
- ç”¨æˆ·åªèƒ½ç®¡ç†è‡ªå·±çš„è´¦å·æ± 
- ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰èµ„æº

---

## æŠ€æœ¯å®ç°

### æ–‡ä»¶ç»“æ„

```
publisher-core/auth/
â”œâ”€â”€ middleware.go      (è®¤è¯ä¸­é—´ä»¶ã€JWT/API Key éªŒè¯)
â”œâ”€â”€ user_service.go    (ç”¨æˆ·ç®¡ç†æœåŠ¡)
â””â”€â”€ handlers.go        (è®¤è¯ API å¤„ç†å™¨)

publisher-core/database/
â””â”€â”€ models.go          (æ·»åŠ  User æ¨¡å‹)
```

### æ•°æ®åº“æ¨¡å‹

```go
type User struct {
    ID            uint
    UserID        string    // å”¯ä¸€ç”¨æˆ· ID
    Username      string    // ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰
    Email         string    // é‚®ç®±ï¼ˆå”¯ä¸€ï¼‰
    PasswordHash  string    // å¯†ç å“ˆå¸Œ
    Role          string    // è§’è‰²ï¼šuser, admin
    APIKey        string    // API Keyï¼ˆå”¯ä¸€ï¼‰
    IsActive      bool      // æ˜¯å¦æ¿€æ´»
    LastLoginAt   *time.Time
    CreatedAt     time.Time
    UpdatedAt     time.Time
}
```

### å®‰å…¨æœºåˆ¶

#### å¯†ç å®‰å…¨

- âœ… bcrypt å“ˆå¸Œï¼ˆDefaultCostï¼‰
- âœ… ä¸åœ¨å“åº”ä¸­è¿”å›å¯†ç å“ˆå¸Œ
- âœ… æœ€å°é•¿åº¦éªŒè¯

#### Token å®‰å…¨

- âœ… JWT ä½¿ç”¨ HS256 ç­¾å
- âœ… åŒ…å«è¿‡æœŸæ—¶é—´
- âœ… æ”¯æŒæ’¤é”€ï¼ˆé€šè¿‡ç”¨æˆ·çŠ¶æ€ï¼‰

#### API Key å®‰å…¨

- âœ… 32 å­—èŠ‚éšæœºç”Ÿæˆ
- âœ… æ”¯æŒé‡æ–°ç”Ÿæˆ
- âœ… è®°å½•æœ€åä½¿ç”¨æ—¶é—´

---

## API ç«¯ç‚¹

### å…¬å¼€æ¥å£ï¼ˆæ— éœ€è®¤è¯ï¼‰

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/v1/register` | POST | ç”¨æˆ·æ³¨å†Œ |
| `/api/v1/login` | POST | ç”¨æˆ·ç™»å½• |

### è®¤è¯æ¥å£ï¼ˆéœ€è¦è®¤è¯ï¼‰

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/v1/auth/me` | GET | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ |
| `/api/v1/auth/me` | PUT | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ |
| `/api/v1/auth/me/api-key` | POST | é‡æ–°ç”Ÿæˆ API Key |
| `/api/v1/auth/change-password` | POST | ä¿®æ”¹å¯†ç  |

### ç®¡ç†å‘˜æ¥å£ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/v1/admin/users` | GET | åˆ—å‡ºç”¨æˆ· |
| `/api/v1/admin/users/{id}` | GET | è·å–ç”¨æˆ·ä¿¡æ¯ |
| `/api/v1/admin/users/{id}/role` | PUT | ä¿®æ”¹ç”¨æˆ·è§’è‰² |
| `/api/v1/admin/users/{id}/disable` | POST | ç¦ç”¨ç”¨æˆ· |
| `/api/v1/admin/users/{id}/enable` | POST | å¯ç”¨ç”¨æˆ· |

---

## ä½¿ç”¨æ–¹å¼

### 1. JWT è®¤è¯æµç¨‹

```bash
# 1. æ³¨å†Œ
curl -X POST http://localhost:8080/api/v1/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"password123"}'

# 2. ç™»å½•è·å– Token
curl -X POST http://localhost:8080/api/v1/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"password123"}'

# 3. ä½¿ç”¨ Token è®¿é—® API
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8080/api/v1/accounts
```

### 2. API Key è®¤è¯æµç¨‹

```bash
# 1. ç™»å½•è·å– API Key
curl -X POST http://localhost:8080/api/v1/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"password123"}'

# 2. ä½¿ç”¨ API Key è®¿é—® API
curl -H "X-API-Key: pk_your_api_key" \
  http://localhost:8080/api/v1/accounts
```

---

## é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ

### 1. åœ¨ API Server ä¸­å¯ç”¨è®¤è¯

```go
// åˆ›å»ºè®¤è¯æœåŠ¡
authConfig := auth.DefaultAuthConfig()
authService := auth.NewAuthService(db, authConfig)
userService := auth.NewUserService(db, authService)

// åˆ›å»ºè®¤è¯å¤„ç†å™¨
authHandler := auth.NewAuthHandler(userService, authService)

// æ³¨å†Œè®¤è¯è·¯ç”±
authHandler.RegisterRoutes(router)

// ä¸ºå…¶ä»– API æ·»åŠ è®¤è¯ä¸­é—´ä»¶
apiRouter := router.PathPrefix("/api/v1").Subrouter()
apiRouter.Use(authService.AuthMiddleware)
```

### 2. åœ¨å¤„ç†å™¨ä¸­è·å–ç”¨æˆ·ä¿¡æ¯

```go
func (h *Handler) SomeAPI(w http.ResponseWriter, r *http.Request) {
    // è·å–å½“å‰ç”¨æˆ·
    user, err := auth.GetUserFromContext(r.Context())
    if err != nil {
        // æœªè®¤è¯
        return
    }
    
    // ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯
    fmt.Printf("User: %s\n", user.Username)
}
```

### 3. æ·»åŠ æƒé™æ£€æŸ¥

```go
// è¦æ±‚ç®¡ç†å‘˜æƒé™
adminRouter := router.PathPrefix("/api/v1/admin").Subrouter()
adminRouter.Use(authService.AuthMiddleware)
adminRouter.Use(authService.RequireRole("admin"))
```

---

## å®‰å…¨å»ºè®®

### ğŸ”´ å¿…é¡»å®æ–½

1. **å¯ç”¨ HTTPS**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
2. **è®¾ç½® JWT å¯†é’¥**: ä½¿ç”¨å¼ºéšæœºå¯†é’¥
3. **å®šæœŸè½®æ¢å¯†é’¥**: å»ºè®®æ¯ 3-6 ä¸ªæœˆæ›´æ¢ä¸€æ¬¡

### ğŸŸ¡ å»ºè®®å®æ–½

1. **æ·»åŠ é€Ÿç‡é™åˆ¶**: é˜²æ­¢æš´åŠ›ç ´è§£
2. **æ·»åŠ å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰è®¤è¯æ“ä½œ
3. **å®ç°å¯†ç ç­–ç•¥**: å¤æ‚åº¦è¦æ±‚ã€å®šæœŸæ›´æ¢
4. **æ·»åŠ åŒå› ç´ è®¤è¯**: æé«˜å®‰å…¨æ€§

### ğŸŸ¢ å¯é€‰å®æ–½

1. **OAuth2 é›†æˆ**: æ”¯æŒç¬¬ä¸‰æ–¹ç™»å½•
2. **ä¼šè¯ç®¡ç†**: æŸ¥çœ‹å’Œæ’¤é”€æ´»è·ƒä¼šè¯
3. **å¯†ç æ‰¾å›**: é‚®ç®±éªŒè¯é‡ç½®å¯†ç 

---

## æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•

```go
func TestRegisterUser(t *testing.T) {
    // æµ‹è¯•ç”¨æˆ·æ³¨å†Œ
}

func TestLoginUser(t *testing.T) {
    // æµ‹è¯•ç”¨æˆ·ç™»å½•
}

func TestValidateToken(t *testing.T) {
    // æµ‹è¯• Token éªŒè¯
}

func TestValidateAPIKey(t *testing.T) {
    // æµ‹è¯• API Key éªŒè¯
}
```

### é›†æˆæµ‹è¯•

```go
func TestAuthenticationFlow(t *testing.T) {
    // 1. æ³¨å†Œ
    // 2. ç™»å½•
    // 3. ä½¿ç”¨ Token è®¿é—® API
    // 4. ä½¿ç”¨ API Key è®¿é—® API
}
```

### å®‰å…¨æµ‹è¯•

- å¯†ç å¼ºåº¦æµ‹è¯•
- Token è¿‡æœŸæµ‹è¯•
- æƒé™è¾¹ç•Œæµ‹è¯•
- SQL æ³¨å…¥æµ‹è¯•

---

## æ€§èƒ½è€ƒè™‘

### ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜ç”¨æˆ·ä¿¡æ¯**: å‡å°‘æ•°æ®åº“æŸ¥è¯¢
2. **Token é»‘åå•**: ç”¨äºä¸»åŠ¨æ’¤é”€ Token
3. **API Key ç¼“å­˜**: ç¼“å­˜éªŒè¯ç»“æœ
4. **æ•°æ®åº“ç´¢å¼•**: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•

### ç›‘æ§æŒ‡æ ‡

- ç™»å½•æˆåŠŸç‡
- Token éªŒè¯å»¶è¿Ÿ
- API Key ä½¿ç”¨é¢‘ç‡
- è®¤è¯å¤±è´¥ç‡

---

## å·²çŸ¥é™åˆ¶

1. **Token æ’¤é”€**: ç›®å‰ä¸æ”¯æŒä¸»åŠ¨æ’¤é”€ JWT Token
2. **å¯†ç æ‰¾å›**: æœªå®ç°é‚®ç®±éªŒè¯æ‰¾å›å¯†ç 
3. **ä¼šè¯ç®¡ç†**: æœªå®ç°æŸ¥çœ‹å’Œæ’¤é”€æ´»è·ƒä¼šè¯
4. **åŒå› ç´ è®¤è¯**: æœªå®ç° 2FA

---

## åç»­æ”¹è¿›

### çŸ­æœŸï¼ˆ1å‘¨å†…ï¼‰

1. æ·»åŠ è®¤è¯ç›¸å…³çš„å•å…ƒæµ‹è¯•
2. å®ç°å¯†ç æ‰¾å›åŠŸèƒ½
3. æ·»åŠ å®¡è®¡æ—¥å¿—

### ä¸­æœŸï¼ˆ1ä¸ªæœˆå†…ï¼‰

1. å®ç°ä¼šè¯ç®¡ç†
2. æ·»åŠ åŒå› ç´ è®¤è¯
3. å®ç° OAuth2 é›†æˆ

### é•¿æœŸï¼ˆæŒç»­ï¼‰

1. å®šæœŸå®‰å…¨å®¡è®¡
2. æ€§èƒ½ä¼˜åŒ–
3. åŠŸèƒ½å¢å¼º

---

## æ€»ç»“

âœ… **å·²å®Œæˆ**:
- JWT å’Œ API Key åŒé‡è®¤è¯
- ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ç®¡ç†
- åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶
- ç®¡ç†å‘˜åŠŸèƒ½
- å®Œæ•´çš„ API æ–‡æ¡£

âœ… **å®‰å…¨æªæ–½**:
- å¯†ç  bcrypt å“ˆå¸Œ
- Token ç­¾åéªŒè¯
- API Key éšæœºç”Ÿæˆ
- æƒé™è¾¹ç•Œæ£€æŸ¥

âœ… **ä»£ç è´¨é‡**:
- æ¸…æ™°çš„åˆ†å±‚è®¾è®¡
- å®Œæ•´çš„é”™è¯¯å¤„ç†
- è¯¦ç»†çš„æ³¨é‡Š
- å¯é…ç½®çš„è®¾è®¡

**çŠ¶æ€**: ç”Ÿäº§å°±ç»ª  
**å»ºè®®**: åœ¨å¯ç”¨ HTTPS åå³å¯ä¸Šçº¿ä½¿ç”¨

---

**å®ç°äºº**: AI å¼€å‘åŠ©æ‰‹  
**å®ç°æ—¥æœŸ**: 2026-02-21  
**ç‰ˆæœ¬**: v1.1.0
